<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>TechNights: Exercise 1</title>
		<style>
		.incorrect {
			background: #ffcccc;
		}
		</style>
	</head>
	<body>
		<h1>Exercise 1</h1>

		<h2>Book titles</h2>
		<ul id="book-titles"></ul>

		<h2>Collect data</h2>
		<p>Start words: <input type="text"></p>
		<table id="word-data">
		  <tr>
		    <th>Current word</th>
		    <th>Next word</th> 
		  </tr>
		</table>

		<button type="button" onclick="checkWork()">Check my work!</button>

		<script>
			var titles = [
			  "The Sisterhood of the Traveling Pants",
			  "Charlie and the Chocolate Factory",
			  "James and the Giant Peach",
			  "Harry Potter and the Sorcerer's Stone",
			  "The Adventures of Tom Sawyer",
			  "Because of Winn-Dixie",
			];

			// Sort alphabetically (case-insensitive)
			function alphabeticalSort(a, b) {
			    var textA = a.toLowerCase();
			    var textB = b.toLowerCase();
			    if (textA < textB) {
			    	return -1;
			    } else if (textA > textB) {
			    	return 1;
			    }
			    return 0;
			}

			// Display the list of book titles on the page
			for (var i = 0; i < titles.length; i++) {
				var node = document.createElement("li");
				var textNode = document.createTextNode(titles[i]);
				node.appendChild(textNode); 
				document.getElementById("book-titles").appendChild(node);
			}

			var startWords = [];
			var wordStats = {};
			var allWords = [];
			// Compile the word data
			for (var i = 0; i < titles.length; i++) {
				var titleWords = titles[i].split(' ')
			    allWords = allWords.concat(titleWords);
			    startWords.push(titleWords[0]);
			    wordStats[titleWords[titleWords.length - 1]] = ["<END>"]
			    for (var j = 0; j < titleWords.length-1; j++) {
			        if (wordStats.hasOwnProperty(titleWords[j])) {
			            wordStats[titleWords[j]].push(titleWords[j+1]);
			        } else {
			            wordStats[titleWords[j]] = [titleWords[j+1]];
			        }
			    }
			}

			// Find the number of unique words
			allWords = allWords.sort(alphabeticalSort).filter(function(word, i, list) {
		        return i == 0 || word != list[i-1];
		    })			

		    var tableBody = document.getElementById("word-data");
		    for (var i = 0; i < allWords.length; i++) {
		    	var row = document.createElement('tr');

		    	// Word label
	    		var wordCell = document.createElement('td');
	    		wordCell.appendChild(document.createTextNode(allWords[i] + ":"));
	    		row.appendChild(wordCell);

	    		// Input box
	    		var inputCell = document.createElement('td');
	    		var input = document.createElement('input');
	    		input.setAttribute('type', 'text')
	    		inputCell.appendChild(input);
	    		row.appendChild(inputCell);

		    	tableBody.appendChild(row);
		    }

		    function checkWork() {
		    	var fields = Array.prototype.slice.call(document.getElementsByTagName('input'));
		    	fields.forEach(function(field) {
		    		field.className = '';
		    	})
		    	var inputtedAnswers = fields.map(function(elt) {
		    		return elt.value;
		    	});


		    	// Split the answers in each text field into tokens
		    	inputtedAnswers = inputtedAnswers.map(function(answer) {
		    		var cleaned = answer.split(',').map(function(token) {
		    			return token.trim();
		    		});
		    		return cleaned;
		    	});
		    	
		    	// Compile the list of correct answers
		    	var correctAnswers = [startWords];
		    	allWords.forEach(function(key) {
		    		correctAnswers.push(wordStats[key]);
		    	});

		    	if (inputtedAnswers.length != correctAnswers.length) {
		    		alert("Oops! Something went wrong. Please get help from one of the volunteers.");
		    		return;
		    	}

		    	var hasError = false;
		    	for (var i = 0; i < inputtedAnswers.length; i++) {
		    		var sortedInput = inputtedAnswers[i].filter(function(answer) {
		    			return answer.length > 0;
		    		}).sort(alphabeticalSort);
		    		var sortedCorrect = correctAnswers[i].filter(function(answer) {
		    			return answer.length > 0;
		    		}).sort(alphabeticalSort);
		    		if (sortedInput.length != sortedCorrect.length) {
		    			var incorrectField = document.getElementsByTagName('input')[i];
		    			incorrectField.className += 'incorrect';
		    			hasError = true;
		    			continue;
		    		}
		    		for (var j = 0; j < sortedInput.length; j++) {
		    			if (sortedInput[j].toLowerCase() != sortedCorrect[j].toLowerCase()) {
		    				var incorrectField = document.getElementsByTagName('input')[i];
		    				incorrectField.className += 'incorrect';
		    				hasError = true;
		    				continue;
		    			}
		    		}
		    	}

		    	if (hasError) {
		    		alert("Not quite. Double check the red text boxes.");
		    	} else {
		    		alert("You got it! Please let the volunteers know that you are done.");
		    	}
		    }
		</script>
	</body>
</html>