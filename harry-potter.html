<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Harry Potter Text Generator</title>
        <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Lato:400,700">
        <style type="text/css">
            * {
                box-sizing: border-box;
                outline: none;
            }

            body {
                font-family: 'Lato';
                line-height: 1.5;
                color: #4c4c4c;
                background-color: #f0f0f0;
                margin: 0;
                border-top: 10px solid #1cb0f6;
            }

            ::-webkit-input-placeholder {
               text-align: center;
            }

            :-moz-placeholder { /* Firefox 18- */
               text-align: center;
            }

            ::-moz-placeholder {  /* Firefox 19+ */
               text-align: center;
            }

            :-ms-input-placeholder {
               text-align: center;
            }

            select {
                background: #fff;
                height: 30px;
                width: 40px;
                border: 2px solid #cfcfcf;
                font-size: 14px;
                font-family: 'Lato';
            }

            button {
                background-color: #1cb0f6;
                color: #fff;
                padding: 0 20px;
                -webkit-border-radius: 999px;
                -moz-border-radius: 999px;
                border-radius: 999px;
                border: 0;
                height: 40px;
                width: 300px;
                text-transform: uppercase;
                font-size: 14px;
                font-family: 'Lato';
            }

            input[type=text] {
                border: 2px solid #cfcfcf;
                border-radius: 6px;
                padding: 10px 15px;
                margin-bottom: 15px;
                color: #4c4c4c;
                font-size: 14px;
                font-family: 'Lato';
                line-height: normal;
                width: 300px;
            }

            input[type=text]:focus, select:focus {
                border-color: #1cb0f6;
            }

            #table-search {
                width: 100%;
                border-top-right-radius: 0;
                border-top-left-radius: 0;
            }

            th, td {
                width: 50%;
                border-bottom: 1px solid #cfcfcf;
            }

            th {
                padding-bottom: 10px;
            }

            td {
                padding: 5px 0;
            }

            #container {
                margin: auto;
                padding-top: 50px;
                width: 70%;
                min-width: 700px;
            }

            #exercise {
                margin: auto;
                width: 100%;
                margin-bottom: 80px;
                margin-top: 40px;
                float: left;
            }

            #left-column {
                float: left;
                width: 50%;
                padding-right: 30px;
                text-align: center;
            }

            #order-section {
                margin-top: 30px;
            }

            #start-words-section {
                margin-top: 80px;
            }

            #next-words-section {
                margin-top: 90px;
            }

            #right-column {
                float: left;
                width: 50%;
            }

            #scroll-box {
                height: 400px;
                width: 100%;
                border: 2px solid #cfcfcf;
                border-radius: 6px;
                overflow: auto;
                background-color: #fff;
                padding: 20px 30px;
            }

            #scroll-box.table-with-search {
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
                border-bottom: 0;
            }

            #message {
                position: relative;
                text-align: center;
                width: 250px;
                top: 140px;
                margin: auto;
            }
        </style>
        <script type="text/javascript">
            function loadJSON(pathToFile, callback) {
               var xobj = new XMLHttpRequest();
                    xobj.overrideMimeType("application/json");
               xobj.open('GET', pathToFile, true);
               xobj.onreadystatechange = function () {
                    if (xobj.readyState == 4 && xobj.status == "200") {
                        callback(xobj.responseText);
                    }
               };
               xobj.send(null);
            }

            var currentModel;
            var order = 1;

            loadJSON('json/hp-order-1.json', function(responseText) {
                currentModel = JSON.parse(responseText);
            });
        </script>
    </head>
    <body>
        <div id="container">
            <h1>Harry Potter Text Generator</h1>
            <p>At this point, we've seen how Markov chains work, and we've trained an order-1 Markov chain on a small set of text to generate book titles. Even with just 6 input titles, we were able to get a variety of results. But this technique usually works better with more input text. Let's see what happens when we give the computer a lot more words to learn from!</p>
            <p>In this exercise, you'll be experimenting with order-<em>n</em> Markov chains that have been trained on all the text in <em>Harry Potter</em> series of books (that's about <em>1 million</em> words!). But what should the value of <em>n</em> be? That's up to you! Experiment with different values of <em>n</em> and see how that changes your results.

            <h2>Instructions</h2>
            <ol>
                <li>Choose a value of <em>n</em> from 1 to 4 in the dropdown below.</li>
                <li>Click "Show starting words" and pick one of the options to start your sentence.</li>
                <li>Take the last <em>n</em> words from your sentence put them in the search box to see what words could come next. Repeat this step until the screen says you've reached the end of the sentence.</li>
                <li>After you reach the end of your sentence, you can go ahead and start another sentence. Remember to try different values of <em>n</em>!</li>
            </ol>

            <div id="exercise">
                <div id="left-column">
                    <div id="order-section">
                        <p>I am using an order-<select id="order" onchange="orderChanged()">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        Markov chain.</p>
                    </div>
                    <div id="start-words-section">
                        <button type="button" onclick="displayStartStates()">Show starting words</button>
                    </div>
                    <div id="next-words-section">
                        <input type="text" id="last-n-words-search" placeholder="Enter the last word of your sentence.">
                        <button type="button" onclick="displayNextWords()">Show possible following words</button>
                    </div>
                </div>

                <div id="right-column">
                    <div id="scroll-box"></div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            // An array of tuples of (word, frequency).
            var tableData;
            var pagesDisplayed = 0;
            var pageSize = 100;
            var startWordsHeader = 'Possible starting words';
            var nextWordsHeader = 'Possible next words';

            function clearScrollBox() {
                var scrollBox = document.getElementById('scroll-box');
                scrollBox.innerHTML = '';
                scrollBox.scrollTop = 0;
                pagesDisplayed = 0;
            }

            function clearInput(id) {
                var lastNWordsSearch = document.getElementById(id);
                lastNWordsSearch.value = '';
            }

            function reset() {
                clearScrollBox();
                removeTableSearchBar();
                clearInput('last-n-words-search')
            }

            function orderChanged() {
                var dropdown = document.getElementById('order');
                var selectedOrder = dropdown.options[dropdown.selectedIndex].value;
                order = parseInt(selectedOrder);
                currentModel = null;

                loadJSON('json/hp-order-' + order + '.json', function(responseText) {
                    currentModel = JSON.parse(responseText);
                });

                reset();

                var searchBox = document.getElementById('last-n-words-search');
                if (order == 1) {
                    searchBox.placeholder = 'Enter the last word of your sentence.';
                } else {
                    searchBox.placeholder = 'Enter the last ' + order + ' words of your sentence.';
                }
            }

            // Sort by frequency, and then by alphabetical order in case of a tie
            function freqAlphaSort(a, b) {
                var freqA = a[1]
                var freqB = b[1];
                if (freqA < freqB) {
                    return 1;
                } else if (freqA > freqB) {
                    return -1;
                } else {
                    if (a[0].toLowerCase() < b[0].toLowerCase()) {
                        return -1;
                    } else if (a[0].toLowerCase() > b[0].toLowerCase()) {
                        return 1;
                    } else {
                        return 0;
                    }
                }
            }

            function addRowsToTable(table) {
                var startingPoint = pageSize*pagesDisplayed;
                var rowsToAdd = Math.min(tableData.length - startingPoint, pageSize);
                for (var i = startingPoint; i < startingPoint + rowsToAdd; i++) {
                    var wordCell = document.createElement('td');
                    var wordText = document.createTextNode(tableData[i][0]);
                    wordCell.appendChild(wordText);

                    var freqCell = document.createElement('td');
                    var freqText = document.createTextNode(tableData[i][1]);
                    freqCell.appendChild(freqText);

                    var row = document.createElement('tr');
                    row.appendChild(wordCell);
                    row.appendChild(freqCell)
                    table.appendChild(row)
                }
                if (rowsToAdd > 0) {
                    pagesDisplayed += 1;
                }
            }

            function addTableSearchBar() {
                var searchInput = document.createElement('input');
                searchInput.type = 'text';
                searchInput.id = 'table-search';
                searchInput.placeholder = 'Search the options in the table';

                var scrollBox = document.getElementById('scroll-box');
                scrollBox.classList.add('table-with-search');

                var rightColumn = document.getElementById('right-column');
                rightColumn.appendChild(searchInput);

                document.getElementById('table-search').onkeyup = function(e){
                    if (!e) e = window.event;
                    var keyCode = e.keyCode || e.which;
                    var searchTerm = e.target.value.trim();

                    if (searchTerm.length == 0) {
                        var currentHeaderText = document.getElementById('left-table-header').textContent;
                        if (currentHeaderText == startWordsHeader) {
                            displayStartStates();
                        } else {
                            displayNextWords();
                        }
                    } else {
                        searchTableData(searchTerm);
                    }
                }
            }

            function removeTableSearchBar() {
                var tableSearch = document.getElementById('table-search');
                if (tableSearch) {
                    document.getElementById('right-column').removeChild(tableSearch);
                    var scrollBox = document.getElementById('scroll-box');
                    scrollBox.classList.remove('table-with-search');
                }
            }

            // Display a table given a mapping of words to frequencies + a header label.
            function displayTable(data, leftHeaderLabel) {
                clearScrollBox();

                var wordTable = document.createElement('table')
                wordTable.id = 'word-table';
                document.getElementById('scroll-box').appendChild(wordTable);

                var leftHeader = document.createElement('th');
                leftHeader.id = 'left-table-header';
                var leftLabel = document.createTextNode(leftHeaderLabel);
                leftHeader.appendChild(leftLabel);

                var rightHeader = document.createElement('th');
                var rightLabel = document.createTextNode('# of occurrences in Harry Potter');
                rightHeader.appendChild(rightLabel);

                var headerRow = document.createElement('tr');
                headerRow.appendChild(leftHeader);
                headerRow.appendChild(rightHeader);
                wordTable.appendChild(headerRow);

                // Sort the possible next words by frequency and alphabetical order
                var wordFreqList = [];
                for (word in data) {
                    wordFreqList.push([word, data[word]]);
                }
                tableData = wordFreqList.sort(freqAlphaSort);

                addRowsToTable(wordTable);

                if (!document.getElementById('table-search')) {
                    addTableSearchBar();
                }
            }

            function displayStartStates() {
                if (currentModel == null) {
                    return;
                }
                clearInput('last-n-words-search');
                displayTable(currentModel['startStates'], startWordsHeader)
            }

            function displayMessage(text) {
                clearScrollBox();
                removeTableSearchBar();

                var messageText = document.createTextNode(text);
                var messageDiv = document.createElement('div');
                messageDiv.id = 'message';
                messageDiv.appendChild(messageText);

                document.getElementById('scroll-box').appendChild(messageDiv);
            }

            function displayNextWords() {
                var tableSearch = document.getElementById('table-search');
                if (tableSearch) {
                    clearInput('table-search');
                }

                var searchTerm = document.getElementById('last-n-words-search').value.trim();

                var searchTermLength = searchTerm.split(' ').length;
                var explanation = 'Your search should have exactly ' + order + ' word' + 's'.repeat(order > 1 ? 1 : 0) + '.'
                if (searchTerm.length == 0 || searchTermLength < order) {
                    displayMessage('That doesn\'t seem to be enough words. ' + explanation);
                    return;
                }
                if (searchTermLength > order) {
                    displayMessage('That\'s too many words. ' + explanation);
                    return;
                }

                if (currentModel['endStates'].includes(searchTerm)) {
                    displayMessage('You\'ve reached the end of the sentence!');
                    return;
                }

                if (currentModel == null) {
                    return;
                }

                var searchTermNextWords = currentModel['wordStats'][searchTerm];
                if (searchTermNextWords == undefined || searchTermNextWords.length == 0) {
                    displayMessage('The text you searched does not appear in the data set.');
                    return;
                }

                displayTable(searchTermNextWords, nextWordsHeader);
            }

            function searchTableData(searchTerm) {
                var searchData = {};
                for (var i = 0; i < tableData.length; i++) {
                    var state = tableData[i][0];
                    if (state.includes(searchTerm)) {
                        searchData[state] = tableData[i][1];
                    }
                }
                var currentHeaderText = document.getElementById('left-table-header').textContent;
                if (Object.keys(searchData).length == 0) {
                    displayTable({'Oops! None of the options contain that text.': ''}, currentHeaderText);
                } else {
                    displayTable(searchData, currentHeaderText);
                }
            }

            displayMessage('Use the controls on the left to get started!');

            // Search when the user presses enter in the input
            document.getElementById('last-n-words-search').onkeypress = function(e){
                if (!e) e = window.event;
                var keyCode = e.keyCode || e.which;
                if (keyCode == '13'){
                    displayNextWords();
                }
            }

            document.getElementById('scroll-box').onscroll = function(e) {
                var table = document.getElementById('word-table');
                var nearBottom = e.target.scrollTop > (e.target.scrollHeight - e.target.offsetHeight - 400);
                if (table != null && nearBottom) {
                    addRowsToTable(document.getElementById('word-table'));
                }
            };

        </script>
    </body>
</html>